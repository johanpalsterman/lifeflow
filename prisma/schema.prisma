// LifeFlow Prisma Schema
// Compatible with PostgreSQL on Azure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION ====================

model User {
  id                String    @id @default(uuid())
  wishflowUserId    String?   @unique @map("wishflow_user_id")
  email             String    @unique
  name              String
  avatarUrl         String?   @map("avatar_url")
  timezone          String    @default("Europe/Brussels")
  locale            String    @default("nl-BE")
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  events            Event[]
  tasks             Task[]
  contacts          Contact[]
  assets            Asset[]
  transactions      Transaction[]
  messages          Message[]
  packages          Package[]
  aiRules           AIRule[]
  wishes            Wish[]
  wishVotes         WishVote[]
  wishComments      WishComment[]
  safetyChecks      SafetyCheck[]
  notifications     Notification[]
  integrations      UserIntegration[]

  // NextAuth
  accounts          Account[]
  sessions          Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==================== CALENDAR & TASKS ====================

model Event {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  externalId      String?   @map("external_id")
  title           String
  description     String?
  location        String?
  startTime       DateTime  @map("start_time")
  endTime         DateTime? @map("end_time")
  allDay          Boolean   @default(false) @map("all_day")
  eventType       String    @default("default") @map("event_type")
  recurrenceRule  String?   @map("recurrence_rule")
  reminderMinutes Int[]     @map("reminder_minutes")
  color           String?
  isSynced        Boolean   @default(false) @map("is_synced")
  syncSource      String?   @map("sync_source")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
  @@index([userId, startTime])
  @@map("events")
}

model Task {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  externalId      String?   @map("external_id")
  title           String
  description     String?
  dueDate         DateTime? @map("due_date")
  priority        String    @default("medium")
  status          String    @default("pending")
  completedAt     DateTime? @map("completed_at")
  listName        String?   @map("list_name")
  tags            String[]
  recurrenceRule  String?   @map("recurrence_rule")
  reminderMinutes Int[]     @map("reminder_minutes")
  isSynced        Boolean   @default(false) @map("is_synced")
  syncSource      String?   @map("sync_source")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@index([userId, status])
  @@map("tasks")
}

// ==================== CONTACTS ====================

model Contact {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  externalId       String?   @map("external_id")
  name             String
  nickname         String?
  email            String?
  phone            String?
  relationshipType String?   @map("relationship_type")
  birthday         DateTime? @db.Date
  anniversary      DateTime? @db.Date
  company          String?
  jobTitle         String?   @map("job_title")
  address          String?
  notes            String?
  avatarUrl        String?   @map("avatar_url")
  isFavorite       Boolean   @default(false) @map("is_favorite")
  lastContactedAt  DateTime? @map("last_contacted_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([birthday])
  @@map("contacts")
}

// ==================== ASSETS & MAINTENANCE ====================

model AssetCategory {
  id                          String   @id @default(uuid())
  name                        String
  icon                        String?
  color                       String?
  defaultMaintenanceIntervalDays Int?  @map("default_maintenance_interval_days")
  createdAt                   DateTime @default(now()) @map("created_at")

  assets           Asset[]
  maintenanceTypes MaintenanceType[]

  @@map("asset_categories")
}

model Asset {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  categoryId    String?   @map("category_id")
  name          String
  description   String?
  brand         String?
  model         String?
  serialNumber  String?   @map("serial_number")
  purchaseDate  DateTime? @map("purchase_date") @db.Date
  purchasePrice Decimal?  @map("purchase_price") @db.Decimal(10, 2)
  warrantyUntil DateTime? @map("warranty_until") @db.Date
  location      String?
  imageUrl      String?   @map("image_url")
  documents     Json      @default("[]")
  customFields  Json      @default("{}")
  status        String    @default("active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        AssetCategory?    @relation(fields: [categoryId], references: [id])
  maintenanceLogs MaintenanceLog[]

  @@index([userId])
  @@index([categoryId])
  @@index([warrantyUntil])
  @@map("assets")
}

model MaintenanceType {
  id              String   @id @default(uuid())
  categoryId      String?  @map("category_id")
  name            String
  description     String?
  defaultIntervalDays Int? @map("default_interval_days")
  defaultCost     Decimal? @map("default_cost") @db.Decimal(10, 2)
  isMandatory     Boolean  @default(false) @map("is_mandatory")
  createdAt       DateTime @default(now()) @map("created_at")

  category        AssetCategory?   @relation(fields: [categoryId], references: [id])
  maintenanceLogs MaintenanceLog[]

  @@map("maintenance_types")
}

model MaintenanceLog {
  id                String    @id @default(uuid())
  assetId           String    @map("asset_id")
  maintenanceTypeId String?   @map("maintenance_type_id")
  performedDate     DateTime  @map("performed_date") @db.Date
  nextDueDate       DateTime? @map("next_due_date") @db.Date
  cost              Decimal?  @db.Decimal(10, 2)
  provider          String?
  notes             String?
  documents         Json      @default("[]")
  mileage           Int?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  asset           Asset            @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceType MaintenanceType? @relation(fields: [maintenanceTypeId], references: [id])

  @@index([assetId])
  @@index([nextDueDate])
  @@map("maintenance_logs")
}

// ==================== FINANCIAL ====================

model Transaction {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  contactId       String?   @map("contact_id")
  transactionType String    @map("transaction_type")
  direction       String
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("EUR")
  description     String?
  referenceNumber String?   @map("reference_number")
  dueDate         DateTime? @map("due_date") @db.Date
  paidDate        DateTime? @map("paid_date") @db.Date
  status          String    @default("pending")
  category        String?
  recurrenceRule  String?   @map("recurrence_rule")
  documents       Json      @default("[]")
  metadata        Json      @default("{}")
  source          String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact  Contact?  @relation(fields: [contactId], references: [id])
  packages Package[]

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@index([userId, status, direction])
  @@map("transactions")
}

// ==================== INBOX & MESSAGES ====================

model Message {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  externalId  String?   @map("external_id")
  source      String
  fromAddress String?   @map("from_address")
  fromName    String?   @map("from_name")
  subject     String?
  preview     String?
  body        String?
  isRead      Boolean   @default(false) @map("is_read")
  isImportant Boolean   @default(false) @map("is_important")
  isArchived  Boolean   @default(false) @map("is_archived")
  category    String?
  tags        String[]
  attachments Json      @default("[]")
  metadata    Json      @default("{}")
  receivedAt  DateTime  @map("received_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([receivedAt])
  @@index([source])
  @@map("messages")
}

// ==================== PACKAGES ====================

model Package {
  id                   String    @id @default(uuid())
  userId               String    @map("user_id")
  trackingNumber       String?   @map("tracking_number")
  carrier              String?
  description          String?
  orderReference       String?   @map("order_reference")
  shopName             String?   @map("shop_name")
  status               String    @default("unknown")
  estimatedDelivery    DateTime? @map("estimated_delivery") @db.Date
  deliveredAt          DateTime? @map("delivered_at")
  trackingUrl          String?   @map("tracking_url")
  trackingHistory      Json      @default("[]") @map("tracking_history")
  relatedTransactionId String?   @map("related_transaction_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  relatedTransaction Transaction? @relation(fields: [relatedTransactionId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([trackingNumber])
  @@map("packages")
}

// ==================== AI RULES ====================

model RuleCategory {
  id          String   @id @default(uuid())
  name        String
  icon        String?
  color       String?
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  rules AIRule[]

  @@map("rule_categories")
}

model AIRule {
  id                 String    @id @default(uuid())
  userId             String    @map("user_id")
  categoryId         String?   @map("category_id")
  name               String
  description        String?
  triggerCondition   Json      @map("trigger_condition")
  triggerDescription String?   @map("trigger_description")
  actionDefinition   Json      @map("action_definition")
  actionDescription  String?   @map("action_description")
  isEnabled          Boolean   @default(true) @map("is_enabled")
  isSystem           Boolean   @default(false) @map("is_system")
  priority           Int       @default(100)
  executionsCount    Int       @default(0) @map("executions_count")
  lastExecutedAt     DateTime? @map("last_executed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category   RuleCategory?   @relation(fields: [categoryId], references: [id])
  executions RuleExecution[]

  @@index([userId])
  @@index([userId, isEnabled])
  @@index([categoryId])
  @@map("ai_rules")
}

model RuleExecution {
  id              String   @id @default(uuid())
  ruleId          String   @map("rule_id")
  triggerData     Json?    @map("trigger_data")
  actionResult    Json?    @map("action_result")
  status          String   @default("success")
  errorMessage    String?  @map("error_message")
  executionTimeMs Int?     @map("execution_time_ms")
  executedAt      DateTime @default(now()) @map("executed_at")

  rule AIRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([executedAt])
  @@map("rule_executions")
}

// ==================== WISH BOARD ====================

model Wish {
  id            String    @id @default(uuid())
  authorId      String    @map("author_id")
  title         String
  description   String
  category      String?
  status        String    @default("new")
  votesCount    Int       @default(0) @map("votes_count")
  commentsCount Int       @default(0) @map("comments_count")
  eta           DateTime? @db.Date
  completedAt   DateTime? @map("completed_at")
  adminNotes    String?   @map("admin_notes")
  isFeatured    Boolean   @default(false) @map("is_featured")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  author   User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  votes    WishVote[]
  comments WishComment[]

  @@index([status])
  @@index([votesCount(sort: Desc)])
  @@index([category])
  @@map("wishes")
}

model WishVote {
  id        String   @id @default(uuid())
  wishId    String   @map("wish_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  wish Wish @relation(fields: [wishId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([wishId, userId])
  @@index([wishId])
  @@index([userId])
  @@map("wish_votes")
}

model WishComment {
  id         String   @id @default(uuid())
  wishId     String   @map("wish_id")
  authorId   String   @map("author_id")
  parentId   String?  @map("parent_id")
  content    String
  isOfficial Boolean  @default(false) @map("is_official")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  wish    Wish          @relation(fields: [wishId], references: [id], onDelete: Cascade)
  author  User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent  WishComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies WishComment[] @relation("CommentReplies")

  @@index([wishId])
  @@index([authorId])
  @@map("wish_comments")
}

// ==================== SAFETY ====================

model SafetyCheck {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  checkType      String    @map("check_type")
  name           String
  description    String?
  lastVerifiedAt DateTime? @map("last_verified_at")
  nextCheckAt    DateTime? @map("next_check_at")
  status         String    @default("unknown")
  checkUrl       String?   @map("check_url")
  checkConfig    Json      @default("{}") @map("check_config")
  isEnabled      Boolean   @default(true) @map("is_enabled")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  history SafetyCheckHistory[]

  @@index([userId])
  @@index([status])
  @@map("safety_checks")
}

model SafetyCheckHistory {
  id            String   @id @default(uuid())
  safetyCheckId String   @map("safety_check_id")
  status        String
  message       String?
  metadata      Json     @default("{}")
  checkedAt     DateTime @default(now()) @map("checked_at")

  safetyCheck SafetyCheck @relation(fields: [safetyCheckId], references: [id], onDelete: Cascade)

  @@index([safetyCheckId])
  @@map("safety_check_history")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  type              String
  title             String
  message           String?
  actionUrl         String?   @map("action_url")
  actionLabel       String?   @map("action_label")
  relatedEntityType String?   @map("related_entity_type")
  relatedEntityId   String?   @map("related_entity_id")
  isRead            Boolean   @default(false) @map("is_read")
  isDismissed       Boolean   @default(false) @map("is_dismissed")
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

// ==================== INTEGRATIONS ====================

model UserIntegration {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  provider      String
  accessToken   String?   @map("access_token")
  refreshToken  String?   @map("refresh_token")
  tokenExpiresAt DateTime? @map("token_expires_at")
  scopes        String[]
  metadata      Json      @default("{}")
  isActive      Boolean   @default(true) @map("is_active")
  lastSyncAt    DateTime? @map("last_sync_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
  @@map("user_integrations")
}

// EMAIL TASKS MODELS

model EmailTask {
  id              String    @id @default(cuid())
  oderId          String    @unique
  userId          String
  
  emailId         String
  emailFrom       String
  emailSubject    String
  emailReceivedAt DateTime
  
  category        String
  confidence      Float     @default(0)
  
  vendor          String?
  summary         String?   @db.Text
  
  amount          Float?
  currency        String?   @default("EUR")
  invoiceNumber   String?
  invoiceDueDate  DateTime?
  paidAt          DateTime?
  
  trackingNumber  String?
  carrier         String?
  expectedDelivery DateTime?
  deliveryStatus  String?
  deliveredAt     DateTime?
  orderNumber     String?
  orderItems      Json?
  
  taskTitle       String
  taskDueDate     DateTime?
  taskPriority    String    @default("medium")
  taskCategory    String?
  taskStatus      String    @default("pending")
  snoozedUntil    DateTime?
  completedAt     DateTime?
  
  rawParsedData   Json?
  
  reminders       TaskReminder[]
  trackingEvents  DeliveryTrackingEvent[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([category])
  @@index([taskStatus])
}

model TaskReminder {
  id              String    @id @default(cuid())
  oderId          String    @unique
  userId          String
  
  emailTaskId     String
  emailTask       EmailTask @relation(fields: [emailTaskId], references: [id], onDelete: Cascade)
  
  title           String
  reminderDate    DateTime
  status          String    @default("pending")
  
  sentAt          DateTime?
  
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([emailTaskId])
}

model DeliveryTrackingEvent {
  id              String    @id @default(cuid())
  
  emailTaskId     String
  emailTask       EmailTask @relation(fields: [emailTaskId], references: [id], onDelete: Cascade)
  
  status          String
  location        String?
  description     String?
  
  timestamp       DateTime
  
  createdAt       DateTime  @default(now())

  @@index([emailTaskId])
}

model EmailConnection {
  id              String    @id @default(cuid())
  userId          String
  
  provider        String
  email           String
  
  accessToken     String?   @db.Text
  refreshToken    String?   @db.Text
  tokenExpiresAt  DateTime?
  
  lastSyncAt      DateTime?
  lastSyncError   String?
  syncEnabled     Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, email])
  @@index([userId])
}

model StandupPreferences {
  id              String    @id @default(cuid())
  userId          String    @unique
  
  enabled         Boolean   @default(true)
  deliveryTime    String    @default("08:00")
  timezone        String    @default("Europe/Amsterdam")
  
  showInApp       Boolean   @default(true)
  sendEmail       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
